name: Upload to S3 and Invalidate CloudFront

on:
  push:
    branches:
      - dev
      - prod
   
jobs:
 CHECKOUT :
   runs-on: ubuntu-latest
   steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        
 DEV-DEPLOY:
   if : github.ref == 'refs/heads/dev'
   runs-on: ubuntu-latest
   needs : [CHECKOUT]
   environment: dev
   steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Configure AWS Credentials Action For GitHub Actions
        uses: aws-actions/configure-aws-credentials@v2
        with:
            aws-access-key-id: ${{ secrets.ACCESS_KEY}}
            aws-secret-access-key: ${{ secrets.SECRET_KEY }}
            aws-region: eu-north-1
             
      - name: Create ZIP file
        run: |
           cd ${{ github.workspace }}
           ls -l
           zip -r ${{ github.workspace }}/mobile-web.zip . -x ./README.md .git\*
      - name: Copy files to S3 (DEV)
        env:
            NAME: ${{ secrets.BUCKET_NAME }}
        run:  aws s3 sync ${{ github.workspace }}/mobile-web.zip s3://$NAME/${{ github.repository }}/${{ github.run_number }}/mobile-web.zip 

 PROD-DEPLOY:
   if : github.ref == 'refs/heads/prod'
   runs-on: ubuntu-latest
   needs : [CHECKOUT]
   environment: prod
   steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Configure AWS Credentials Action For GitHub Actions
        uses: aws-actions/configure-aws-credentials@v2
        with:
            aws-access-key-id: ${{ secrets.ACCESS_KEY}}
            aws-secret-access-key: ${{ secrets.SECRET_KEY }}
            aws-region: eu-north-1
             
      - name: Create ZIP file
        run: |
           cd ${{ github.workspace }}
           ls -l
           zip -r ${{ github.workspace }}/mobile-web.zip . -x ./README.md .git\*
      - name: Copy files to S3 (DEV)
        env:
            NAME: ${{ secrets.BUCKET_NAME }}
        run:  aws s3 cp ${{ github.workspace }}/mobile-web.zip s3://$NAME/${{ github.repository }}/${{ github.run_number }}/mobile-web.zip 
      - name : Deploy to cloudfront
        env:
            NAME: ${{ secrets.BUCKET_NAME }}
        run: aws s3 sync ${{ github.workspace }} s3://$NAME/${{ github.repository }}/${{ github.run_number }}/mobile-web.zip  --delete --exclude "README.md" --exclude ".git*"
